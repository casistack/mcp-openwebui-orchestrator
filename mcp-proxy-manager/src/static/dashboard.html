<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP OpenWebUI Docker Orchestrator - Status Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .servers-section, .integration-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            color: white;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .server-grid {
            display: grid;
            gap: 15px;
        }

        .server-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .server-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .server-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .server-name {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-healthy {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
        }

        .status-unhealthy {
            background: linear-gradient(45deg, #f44336, #ef5350);
            color: white;
        }

        .status-auth-error {
            background: linear-gradient(45deg, #FF9800, #FFB74D);
            color: white;
        }

        .status-failed {
            background: linear-gradient(45deg, #9C27B0, #BA68C8);
            color: white;
        }

        .status-skipped {
            background: linear-gradient(45deg, #607D8B, #90A4AE);
            color: white;
        }

        .server-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: bold;
            font-family: 'Monaco', 'Menlo', monospace;
            word-break: break-all;
            max-width: 100%;
        }
        
        .detail-value a {
            color: #81C784 !important;
            text-decoration: none !important;
            transition: color 0.2s ease;
        }
        
        .detail-value a:hover {
            color: #A5D6A7 !important;
            text-decoration: underline !important;
        }

        .integration-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .integration-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .url-list {
            display: grid;
            gap: 10px;
        }

        .url-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            border-left: 4px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            min-width: 60px;
            position: relative;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .auto-refresh input {
            margin-right: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .error {
            background: linear-gradient(45deg, #f44336, #ef5350);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .server-details {
                grid-template-columns: 1fr;
            }
        }

        .emoji {
            font-size: 1.2em;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Responsive tooltip positioning */
        @media (max-width: 768px) {
            .tooltip .tooltip-text {
                width: 250px;
                margin-left: -125px;
                font-size: 0.8rem;
            }
        }

        /* Environment Management Styles */
        .env-server-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .env-server-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .env-server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .env-server-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .env-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .env-status-complete {
            background: rgba(76, 175, 80, 0.8);
            color: white;
        }

        .env-status-missing {
            background: rgba(255, 152, 0, 0.3);
            color: #FF9800;
        }

        .env-status-none {
            background: rgba(158, 158, 158, 0.3);
            color: #9E9E9E;
        }

        .env-variables {
            display: grid;
            gap: 8px;
            margin-top: 10px;
        }

        .env-variable {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .env-variable-required {
            border-left: 4px solid #FF9800;
        }

        .env-variable-optional {
            border-left: 4px solid #4CAF50;
        }

        .env-variable-set {
            opacity: 1;
        }

        .env-variable-missing {
            opacity: 0.6;
        }

        .env-variable-value {
            color: #BBB;
            font-style: italic;
        }

        .env-add-btn {
            background: rgba(76, 175, 80, 0.3);
            border: none;
            color: #4CAF50;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .env-add-btn:hover {
            background: rgba(76, 175, 80, 0.5);
            transform: scale(1.05);
        }

        /* Environment Modal */
        .env-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .env-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 30px;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: white;
        }

        .env-modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .env-form-group {
            margin-bottom: 20px;
        }

        .env-form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1rem;
        }

        .env-form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .env-form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .env-form-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
        }

        .env-form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        .env-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .env-btn-save {
            background: rgba(76, 175, 80, 0.8);
            color: white;
        }

        .env-btn-save:hover {
            background: rgba(76, 175, 80, 1);
            transform: translateY(-2px);
        }

        .env-btn-cancel {
            background: rgba(158, 158, 158, 0.3);
            color: white;
        }

        .env-btn-cancel:hover {
            background: rgba(158, 158, 158, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">🚀</span> MCP OpenWebUI Docker Orchestrator</h1>
            <p id="headerDescription">Real-time monitoring dashboard for MCP server proxies and OpenWebUI integration</p>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-refresh every 10 seconds</label>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalServers">-</div>
                <div class="stat-label"><span class="emoji">📊</span> Total Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="healthyServers">-</div>
                <div class="stat-label"><span class="emoji">✅</span> Healthy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedServers">-</div>
                <div class="stat-label"><span class="emoji">❌</span> Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="skippedServers">-</div>
                <div class="stat-label"><span class="emoji">⚪</span> Skipped</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgResponseTime">-</div>
                <div class="stat-label"><span class="emoji">⚡</span> Avg Response (ms)</div>
            </div>
        </div>

        <div class="main-content">
            <div class="servers-section">
                <h2 class="section-title">
                    <span class="emoji">🖥️</span> Server Status
                </h2>
                <div id="serverList" class="server-grid">
                    <div class="loading">Loading server information...</div>
                </div>
            </div>

            <div class="integration-section">
                <h2 class="section-title">
                    <span class="emoji">🔗</span> OpenWebUI Integration
                </h2>
                <div class="integration-card">
                    <div class="integration-title">
                        <span class="emoji">📋</span> Healthy Endpoints
                    </div>
                    <div id="endpointsList" class="url-list">
                        <div class="loading">Loading endpoints...</div>
                    </div>
                </div>

                <div class="integration-card">
                    <div class="integration-title">
                        <span class="emoji">⚙️</span> OpenWebUI Setup Instructions
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 15px; opacity: 0.9;">
                            <strong>Step 1:</strong> Copy the healthy endpoint URLs above<br>
                            <strong>Step 2:</strong> Go to your OpenWebUI instance<br>
                            <strong>Step 3:</strong> Choose your configuration method:
                        </p>
                        <div style="margin: 10px 0; padding-left: 15px;">
                            <p style="margin: 8px 0; font-size: 0.9rem;"><strong>👤 User Tools:</strong> Settings → Tools → Add URLs</p>
                            <p style="margin: 8px 0; font-size: 0.9rem;"><strong>🔧 Admin Tools:</strong> Admin Panel → Settings → Tools</p>
                            <p style="margin: 8px 0; font-size: 0.9rem;"><strong>🤖 Model Tools:</strong> Workspace → Models → Edit → Tools</p>
                        </div>
                        <p style="font-size: 0.9rem; opacity: 0.8; font-style: italic;">
                            💡 Each endpoint provides OpenAPI-compatible REST APIs for MCP tools
                        </p>
                    </div>
                    <div class="integration-title" style="margin-top: 20px;">
                        <span class="emoji">🌍</span> Container Environment
                        <button class="env-add-btn" onclick="openContainerEnvModal()" style="margin-left: 10px; background: rgba(76, 175, 80, 0.8); color: white;">Manage Global</button>
                        <button class="env-add-btn" onclick="testContainerEnvironment()" style="margin-left: 5px; background: rgba(255, 152, 0, 0.8); color: white;">Test</button>
                        <button class="env-add-btn" onclick="reloadConfiguration()" style="margin-left: 5px; background: rgba(33, 150, 243, 0.8); color: white;">Reload Config</button>
                    </div>
                    <div id="containerEnvironmentSection">
                        <div class="loading">Loading container environment data...</div>
                    </div>
                    
                    <div class="integration-title" style="margin-top: 20px;">
                        <span class="emoji">📊</span> Management API
                    </div>
                    <div class="url-item" style="margin-bottom: 10px;">
                        <span>http://localhost:3001/status</span>
                        <button class="copy-btn" onclick="copyToClipboard('http://localhost:3001/status')">Copy</button>
                    </div>
                    <div class="url-item">
                        <span>http://localhost:3001/dashboard</span>
                        <button class="copy-btn" onclick="copyToClipboard('http://localhost:3001/dashboard')">Copy</button>
                    </div>
                </div>
            </div>
        </div>

        <button class="refresh-btn" onclick="refreshData()" title="Refresh Data">
            <span class="emoji">🔄</span>
        </button>
        
        <!-- Container Environment Modal -->
        <div id="containerEnvModal" class="env-modal">
            <div class="env-modal-content">
                <div class="env-modal-header">
                    <span class="emoji">🌍</span> Global Container Environment Variables
                </div>
                <div style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                    <p><strong>Container-level variables</strong> are accessible globally via <code>echo $VARIABLE_NAME</code></p>
                    <p>These supplement process-level variables set in server configurations.</p>
                </div>
                <div class="env-form-group">
                    <label class="env-form-label">Variable Name</label>
                    <input 
                        type="text" 
                        class="env-form-input" 
                        id="containerEnvKey"
                        placeholder="e.g., SMITHERY_API_KEY"
                        style="text-transform: uppercase;"
                        pattern="[A-Z_][A-Z0-9_]*"
                    />
                </div>
                <div class="env-form-group">
                    <label class="env-form-label">Variable Value</label>
                    <input 
                        type="password" 
                        class="env-form-input" 
                        id="containerEnvValue"
                        placeholder="Enter the value (leave empty to unset)"
                        autocomplete="new-password"
                    />
                </div>
                <div class="env-form-buttons">
                    <button class="env-btn env-btn-cancel" onclick="closeContainerEnvModal()">Cancel</button>
                    <button class="env-btn env-btn-save" onclick="saveContainerEnvironmentVariable()">Set Variable</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        async function fetchData() {
            try {
                const [statusResponse, endpointsResponse, containerEnvResponse] = await Promise.all([
                    fetch('/status'),
                    fetch('/openapi-endpoints'),
                    fetch('/container-environment')
                ]);

                if (!statusResponse.ok || !endpointsResponse.ok || !containerEnvResponse.ok) {
                    throw new Error('Failed to fetch data');
                }

                const statusData = await statusResponse.json();
                const endpointsData = await endpointsResponse.json();
                const containerEnvironmentData = await containerEnvResponse.json();

                return { statusData, endpointsData, containerEnvironmentData };
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        function updateStats(statusData) {
            try {
                // Update header description based on mode
                const headerDescription = document.getElementById('headerDescription');
                if (statusData.mode === 'unified') {
                    headerDescription.textContent = '🔗 Unified Mode: Single MCPO process with route-based access for all MCP servers';
                } else {
                    headerDescription.textContent = '⚙️ Individual Mode: Separate proxy processes for each MCP server';
                }
                
                // Handle both individual and unified modes
                let totalServers, healthyServers, failedServers, skippedServers, avgResponseTime;
                
                if (statusData.mode === 'unified') {
                    // Unified mode: single MCPO process
                    totalServers = statusData.summary?.total || 0;
                    healthyServers = statusData.summary?.healthy || 0;
                    failedServers = statusData.summary?.failed || 0;
                    skippedServers = statusData.summary?.skipped || 0;
                    avgResponseTime = statusData.unifiedProxy ? Math.round(statusData.unifiedProxy.uptime / 1000) : 0;
                } else {
                    // Individual mode: separate proxies
                    const proxies = statusData.proxies || [];
                    totalServers = proxies.length;
                    
                    // Properly categorize servers according to comprehensive status system
                    healthyServers = proxies.filter(p => 
                        p.healthy && p.status !== 'failed' && p.status !== 'skipped'
                    ).length;
                    
                    // Count failed servers specifically
                    failedServers = proxies.filter(p => 
                        p.status === 'failed'
                    ).length;
                    
                    // Count skipped servers (SSE transport, no proxy needed)
                    skippedServers = proxies.filter(p => 
                        p.status === 'skipped'
                    ).length;
                    
                    // Calculate average response time from healthy servers only
                    const healthyProxies = proxies.filter(p => p.healthy && p.uptime > 0);
                    avgResponseTime = healthyProxies.length > 0 
                        ? Math.round(healthyProxies.reduce((sum, p) => sum + (p.uptime || 0), 0) / healthyProxies.length)
                        : 0;
                }

                // Update DOM with calculated values
                document.getElementById('totalServers').textContent = totalServers;
                document.getElementById('healthyServers').textContent = healthyServers;
                document.getElementById('failedServers').textContent = failedServers;
                document.getElementById('skippedServers').textContent = skippedServers;
                document.getElementById('avgResponseTime').textContent = avgResponseTime;
            } catch (error) {
                console.error('Error updating stats:', error);
                // Set fallback values
                document.getElementById('totalServers').textContent = 'Error';
                document.getElementById('healthyServers').textContent = 'Error';
                document.getElementById('failedServers').textContent = 'Error';
                document.getElementById('skippedServers').textContent = 'Error';
                document.getElementById('avgResponseTime').textContent = 'Error';
            }
            
            // Debug logging for troubleshooting
            const debugInfo = {
                mode: statusData.mode,
                total: totalServers,
                healthy: healthyServers,
                failed: failedServers,
                skipped: skippedServers,
                avgResponseTime
            };
            
            // Add mode-specific debug info
            if (statusData.mode === 'unified') {
                debugInfo.unifiedProxy = statusData.unifiedProxy ? {
                    healthy: statusData.unifiedProxy.healthy,
                    port: statusData.unifiedProxy.port,
                    uptime: statusData.unifiedProxy.uptime
                } : null;
                debugInfo.serverRoutes = statusData.serverRoutes ? statusData.serverRoutes.length : 0;
            } else {
                debugInfo.proxies = statusData.proxies ? statusData.proxies.map(p => ({
                    id: p.serverId,
                    healthy: p.healthy,
                    status: p.status
                })) : [];
            }
            
            console.log('Stats updated:', debugInfo);
        }

        function getStatusBadge(proxy) {
            if (proxy.status === 'skipped') {
                return `<div class="tooltip">
                    <span class="status-badge status-skipped">Skipped (SSE)</span>
                    <span class="tooltip-text">
                        <strong>Server Skipped</strong><br>
                        This server uses SSE (Server-Sent Events) transport and connects directly to Claude Desktop. No proxy needed.
                    </span>
                </div>`;
            } else if (proxy.status === 'failed') {
                const reason = proxy.reason || 'Unknown failure reason';
                let attemptsText = '';
                if (proxy.fallbackInfo && proxy.fallbackInfo.attemptedTypes) {
                    attemptsText = '<br><br><strong>Attempted fixes:</strong><br>' + proxy.fallbackInfo.attemptedTypes.join(', ');
                }
                
                // Add error type info if available
                let errorTypeText = '';
                if (proxy.errorType && proxy.errorType !== 'unknown') {
                    const typeMap = {
                        'auth': '🔐 Authentication',
                        'connection': '🔗 Connection', 
                        'resource': '💾 Resource',
                        'dependency': '📦 Dependencies',
                        'config': '⚙️ Configuration',
                        'runtime': '⚠️ Runtime',
                        'health': '❤️ Health Check'
                    };
                    errorTypeText = '<br><br><strong>Error Type:</strong> ' + (typeMap[proxy.errorType] || proxy.errorType);
                }
                
                return `<div class="tooltip">
                    <span class="status-badge status-failed">Failed</span>
                    <span class="tooltip-text">
                        <strong>Server Failed</strong><br>
                        ${reason}
                        ${errorTypeText}
                        ${attemptsText}
                    </span>
                </div>`;
            } else if (proxy.authError) {
                return `<div class="tooltip">
                    <span class="status-badge status-auth-error">Auth Required</span>
                    <span class="tooltip-text">
                        <strong>Authentication Required</strong><br>
                        This server requires external authentication (API key, login, etc.). Please configure the required credentials.
                    </span>
                </div>`;
            } else if (proxy.healthy) {
                return '<span class="status-badge status-healthy">Healthy</span>';
            } else {
                return '<span class="status-badge status-unhealthy">Unhealthy</span>';
            }
        }

        function formatUptime(uptime) {
            const seconds = Math.floor(uptime / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function updateServerList(statusData) {
            const serverList = document.getElementById('serverList');
            
            try {
                if (statusData.mode === 'unified') {
                // Unified mode: show unified MCPO info and server routes
                if (!statusData.unifiedProxy) {
                    serverList.innerHTML = '<div class="loading">No unified proxy found</div>';
                    return;
                }
                
                const unifiedProxyHTML = `
                    <div class="server-card" style="border: 2px solid #4CAF50;">
                        <div class="server-header">
                            <div class="server-name">🔗 Unified MCPO (All Servers)</div>
                            <div class="status-badge healthy">✅ Healthy</div>
                        </div>
                        <div class="server-details">
                            <div class="detail-item">
                                <div class="detail-label">Port</div>
                                <div class="detail-value">${statusData.unifiedProxy.port}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Proxy Type</div>
                                <div class="detail-value">unified-mcpo</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Uptime</div>
                                <div class="detail-value">${formatUptime(statusData.unifiedProxy.uptime || 0)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Restarts</div>
                                <div class="detail-value">${statusData.unifiedProxy.restartCount || 0}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Servers</div>
                                <div class="detail-value">${statusData.unifiedProxy.totalServers}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Main Docs</div>
                                <div class="detail-value">
                                    <a href="${statusData.unifiedProxy.endpoint}/docs" target="_blank">
                                        📖 API Docs
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add individual server routes
                const routesHTML = statusData.serverRoutes ? statusData.serverRoutes.map(route => `
                    <div class="server-card">
                        <div class="server-header">
                            <div class="server-name">${route.id}</div>
                            <div class="status-badge healthy">✅ Route</div>
                        </div>
                        <div class="server-details">
                            <div class="detail-item">
                                <div class="detail-label">Route</div>
                                <div class="detail-value">${route.route}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Type</div>
                                <div class="detail-value">${route.type}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Base URL</div>
                                <div class="detail-value">
                                    <a href="${route.baseUrl}" target="_blank" title="${route.baseUrl}">
                                        /${route.id}
                                    </a>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Docs</div>
                                <div class="detail-value">
                                    <a href="${route.docsUrl}" target="_blank">
                                        📖 View Docs
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') : '';
                
                serverList.innerHTML = unifiedProxyHTML + routesHTML;
            } else {
                // Individual mode: original logic
                const proxies = statusData.proxies || [];
                if (proxies.length === 0) {
                    serverList.innerHTML = '<div class="loading">No servers found</div>';
                    return;
                }

                const serversHTML = proxies.map(proxy => `
                    <div class="server-card">
                        <div class="server-header">
                            <div class="server-name">${proxy.serverId}</div>
                            ${getStatusBadge(proxy)}
                        </div>
                        <div class="server-details">
                            <div class="detail-item">
                                <div class="detail-label">Port</div>
                                <div class="detail-value">${proxy.port || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Proxy Type</div>
                                <div class="detail-value">${proxy.proxyType || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Uptime</div>
                                <div class="detail-value">${formatUptime(proxy.uptime || 0)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Restarts</div>
                                <div class="detail-value">${proxy.restartCount || 0}</div>
                            </div>
                            ${proxy.endpoint ? `
                            <div class="detail-item">
                                <div class="detail-label">OpenAPI</div>
                                <div class="detail-value">
                                    <a href="${proxy.endpoint}/openapi.json" target="_blank" style="color: #4CAF50;">
                                        /openapi.json
                                    </a>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Docs</div>
                                <div class="detail-value">
                                    <a href="${proxy.endpoint}/docs" target="_blank" style="color: #4CAF50;">
                                        /docs
                                    </a>
                                </div>
                            </div>` : ''}
                            <div class="detail-item">
                                <div class="detail-label">Fallback Used</div>
                                <div class="detail-value">${proxy.fallbackUsed ? 'Yes' : 'No'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                serverList.innerHTML = serversHTML;
            }
            } catch (error) {
                console.error('Error updating server list:', error);
                serverList.innerHTML = '<div class="error">Error loading server data: ' + error.message + '</div>';
            }
        }

        function updateEndpointsList(endpointsData) {
            const endpointsList = document.getElementById('endpointsList');
            
            if (endpointsData.endpoints.length === 0) {
                endpointsList.innerHTML = '<div class="loading">No healthy endpoints available</div>';
                return;
            }

            const endpointsHTML = endpointsData.endpoints.map(endpoint => `
                <div class="url-item">
                    <span>${endpoint.url}</span>
                    <button class="copy-btn" onclick="copyToClipboard('${endpoint.url}')">Copy</button>
                </div>
            `).join('');

            endpointsList.innerHTML = endpointsHTML;
        }

        function copyToClipboard(text) {
            console.log('Copy function called with:', text);
            const button = event.target;
            const originalText = button.textContent;

            // Debug info
            console.log('Clipboard API available:', !!navigator.clipboard);
            console.log('Secure context:', window.isSecureContext);

            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyFeedback(button, originalText);
                }).catch(() => {
                    // Fallback to legacy method
                    fallbackCopyToClipboard(text, button, originalText);
                });
            } else {
                // Use fallback method
                fallbackCopyToClipboard(text, button, originalText);
            }
        }

        function fallbackCopyToClipboard(text, button, originalText) {
            try {
                // Create temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                // Try to copy
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showCopyFeedback(button, originalText);
                } else {
                    showCopyError(button, originalText);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showCopyError(button, originalText);
            }
        }

        function showCopyFeedback(button, originalText) {
            button.textContent = 'Copied! ✓';
            button.style.background = 'rgba(76, 175, 80, 0.3)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }

        function showCopyError(button, originalText) {
            button.textContent = 'Copy Failed';
            button.style.background = 'rgba(244, 67, 54, 0.3)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
            
            // Show manual copy instruction
            const text = button.parentElement.querySelector('span').textContent;
            alert(`Copy failed. Please manually copy this URL:\n\n${text}`);
        }

        async function refreshData() {
            try {
                const { statusData, endpointsData, containerEnvironmentData } = await fetchData();
                
                updateStats(statusData);
                updateServerList(statusData);
                updateEndpointsList(endpointsData);
                updateContainerEnvironmentSection(containerEnvironmentData);

                // Update last refresh time
                console.log('Data refreshed at:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Failed to refresh data:', error);
                document.getElementById('serverList').innerHTML = 
                    '<div class="error">Failed to load server data. Please check if the MCP OpenWebUI Docker Orchestrator is running.</div>';
                document.getElementById('endpointsList').innerHTML = 
                    '<div class="error">Failed to load endpoints.</div>';
                document.getElementById('containerEnvironmentSection').innerHTML = 
                    '<div class="error">Failed to load container environment data.</div>';
            }
        }


        // Container Environment Functions
        
        function updateContainerEnvironmentSection(containerEnvironmentData) {
            const section = document.getElementById('containerEnvironmentSection');
            
            if (!containerEnvironmentData.globalVariables || Object.keys(containerEnvironmentData.globalVariables).length === 0) {
                section.innerHTML = '<div class="env-server-card" style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;"><span class="emoji">🌍</span> No global environment variables set<br><small>Use "Manage Global" to add container-level variables</small></div>';
                return;
            }

            const globalVarsHTML = Object.entries(containerEnvironmentData.globalVariables)
                .map(([key, data]) => {
                    return `<div class="env-variable env-variable-set" style="border-left: 4px solid #2196F3;">
                        <span>${key} (Global)</span>
                        <span class="env-variable-value">${data.masked}</span>
                    </div>`;
                }).join('');

            const statsHTML = containerEnvironmentData.stats ? `
                <div style="margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                    ${containerEnvironmentData.stats.globalVariablesCount} global variables • 
                    Accessible via: <code>echo $VARIABLE_NAME</code>
                </div>
            ` : '';

            section.innerHTML = `
                <div class="env-server-card">
                    <div class="env-server-header">
                        <span class="env-server-name">Global Container Variables</span>
                        <div>
                            <span class="env-status env-status-complete">${Object.keys(containerEnvironmentData.globalVariables).length} Active</span>
                        </div>
                    </div>
                    <div class="env-variables">
                        ${globalVarsHTML}
                        ${statsHTML}
                    </div>
                </div>
            `;
        }

        function openContainerEnvModal() {
            document.getElementById('containerEnvKey').value = '';
            document.getElementById('containerEnvValue').value = '';
            document.getElementById('containerEnvModal').style.display = 'block';
        }

        function closeContainerEnvModal() {
            document.getElementById('containerEnvModal').style.display = 'none';
        }

        async function saveContainerEnvironmentVariable() {
            const key = document.getElementById('containerEnvKey').value.trim().toUpperCase();
            const value = document.getElementById('containerEnvValue').value.trim();

            if (!key) {
                alert('Please enter a variable name');
                return;
            }

            if (!key.match(/^[A-Z_][A-Z0-9_]*$/)) {
                alert('Invalid variable name. Use only uppercase letters, numbers, and underscores.');
                return;
            }

            try {
                const response = await fetch('/container-environment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        key, 
                        value: value || null,
                        action: value ? 'set' : 'unset'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`✅ ${result.message}\n\nVariable is now accessible globally in the container.`);
                    closeContainerEnvModal();
                    refreshData(); // Refresh to show updated status
                } else {
                    alert(`❌ Failed to save: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to save container environment variable:', error);
                alert('Failed to save container environment variable');
            }
        }

        async function testContainerEnvironment() {
            try {
                const response = await fetch('/container-environment/test');
                const result = await response.json();

                if (result.testResult.containerEnvironmentWorking) {
                    alert(`✅ Container Environment Test Passed!\n\n${result.instructions.description}\n\nGlobal environment variables are accessible in new shell sessions.`);
                } else {
                    alert(`❌ Container Environment Test Failed\n\nDetails: ${result.testResult.error || 'Environment variables may not be accessible globally'}\n\nTroubleshooting: ${result.instructions.troubleshooting}`);
                }
            } catch (error) {
                console.error('Failed to test container environment:', error);
                alert('Failed to run container environment test');
            }
        }

        async function reloadConfiguration() {
            try {
                const response = await fetch('/config/reload', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(`✅ Configuration Reloaded Successfully!\n\n${result.message}\n\nAll servers have been restarted with updated configurations.`);
                    refreshData(); // Refresh dashboard to show updated status
                } else {
                    alert(`❌ Configuration Reload Failed\n\nError: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to reload configuration:', error);
                alert('Failed to reload configuration');
            }
        }

        // Close container modal when clicking outside
        document.getElementById('containerEnvModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeContainerEnvModal();
            }
        });

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            function toggleAutoRefresh() {
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(refreshData, 10000);
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                    }
                }
            }

            checkbox.addEventListener('change', toggleAutoRefresh);
            
            // Start auto-refresh by default
            toggleAutoRefresh();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            setupAutoRefresh();
        });
    </script>
</body>
</html>